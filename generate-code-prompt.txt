# è§’è‰²

å¦³æ˜¯ä¸€ä½å°ç£çš„æ•™è‚²å°ˆå®¶ã€é›»è…¦ç§‘å­¸å®¶ã€è»Ÿé«”å·¥ç¨‹å¸«ï¼Œæ“…é•·é ˜åŸŸåŒ…å«è¼”å°å°ç£é«˜ä¸­ç”Ÿå‚™è€ƒã€é–‹ç™¼å‚™è€ƒç³»çµ±ã€‚

# ä»»å‹™

è«‹å¦³æ ¹æ“šæˆ‘æä¾›çš„å•é¡Œèˆ‡åŸå°ˆæ¡ˆå…§å®¹ï¼Œä¸¦åƒè€ƒæˆ‘æå‡ºçš„è¦æ±‚èˆ‡æ ¼å¼ï¼Œçµ¦äºˆéœ€è¦çš„å…§å®¹ã€‚

# è¦æ±‚

1. è«‹å›è¦†çµ¦æˆ‘éœ€è¦çš„ç¨‹å¼ç¢¼å°±å¥½ã€‚
2. è«‹ä¸è¦çµ¦æˆ‘é¡å¤–çš„èªªæ˜æˆ–è§£é‡‹ã€‚
3. ä½¿ç”¨èŠç‰¹ç´ç³»çµ±è™•ç†ç¨‹å¼å…§çš„å°æ‡‰é‚è¼¯ã€‚

# æ ¼å¼

ç”¨ Python èªè¨€æ’°å¯«ç¨‹å¼ç¢¼ï¼Œä¸¦ä½¿ç”¨ Markdown èªæ³•å€å¡Šå‘ˆç¾ï¼Œæ–¹ä¾¿æˆ‘ç›´æ¥è¤‡è£½è²¼ä¸Šã€‚

# å•é¡Œ

å»ºç«‹ä¸€å€‹æ–°çš„ `scheduler.py` æ¨¡çµ„ï¼Œåœ¨å…¶ä¸­ç·¨å¯« `update_review_schedule(task, performance)` å‡½å¼ã€‚æ­¤å‡½å¼æ ¹æ“š ã€Œgoodã€ã€ã€Œokã€ã€ã€Œbadã€çš„è¡¨ç¾ä¾†èª¿æ•´ä»»å‹™çš„ä¸‹ä¸€æ¬¡è¤‡ç¿’æ—¥æœŸèˆ‡é–“éš”ã€‚

# åŸå°ˆæ¡ˆå…§å®¹

* main.py
```python
import json
import sys
from typing import List, Dict, Any, Optional
from pathlib import Path
import typer
from colorama import Fore, Style, init
from datetime import datetime

# åˆå§‹åŒ– colorama
init(autoreset=True)

# --- å¸¸æ•¸å®šç¾© ---
# ä½¿ç”¨ Path ç‰©ä»¶ä¾†è™•ç†æª”æ¡ˆè·¯å¾‘ï¼Œæ›´å…·å½ˆæ€§
CWD = Path(__file__).parent
SUBJECTS_FILE = CWD / "subjects.json"
TASKS_FILE = CWD / "tasks.json"
RESOURCES_FILE = CWD / "resources.json"


# --- è¼”åŠ©å‡½å¼ (æª”æ¡ˆè™•ç†) ---

def load_data(filepath: Path) -> Any:
    """è¼‰å…¥ JSON æª”æ¡ˆä¸¦å›å‚³å…¶å…§å®¹ã€‚è‹¥æª”æ¡ˆä¸å­˜åœ¨æˆ–æ ¼å¼éŒ¯èª¤ï¼Œå‰‡å›å‚³ç©ºåˆ—è¡¨ã€‚"""
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            return json.load(f)
    except FileNotFoundError:
        # typer.secho æ˜¯ typer å…§å»ºçš„å½©è‰² printï¼Œæ›´æ–¹ä¾¿
        typer.secho(f"è­¦å‘Šï¼šæ‰¾ä¸åˆ°æª”æ¡ˆ {filepath}ã€‚å°‡è¦–ç‚ºç©ºæª”æ¡ˆè™•ç†ã€‚", fg=typer.colors.YELLOW)
        return []
    except json.JSONDecodeError:
        typer.secho(f"éŒ¯èª¤ï¼šæª”æ¡ˆ {filepath} æ ¼å¼ä¸æ­£ç¢ºã€‚", fg=typer.colors.RED)
        sys.exit(1) # ç™¼ç”Ÿåš´é‡éŒ¯èª¤æ™‚ç›´æ¥é€€å‡ºç¨‹å¼

def save_data(filepath: Path, data: Any):
    """å°‡è³‡æ–™ä»¥ç¾è§€çš„ JSON æ ¼å¼å„²å­˜è‡³æª”æ¡ˆã€‚"""
    try:
        with open(filepath, 'w', encoding='utf-8') as f:
            # indent=2 è®“ JSON æ ¼å¼åŒ–ï¼Œæ–¹ä¾¿é–±è®€
            # ensure_ascii=False ç¢ºä¿ä¸­æ–‡èƒ½æ­£å¸¸é¡¯ç¤º
            json.dump(data, f, indent=2, ensure_ascii=False)
    except IOError as e:
        typer.secho(f"éŒ¯èª¤ï¼šç„¡æ³•å¯«å…¥æª”æ¡ˆ {filepath}ã€‚éŒ¯èª¤è¨Šæ¯ï¼š{e}", fg=typer.colors.RED)
        sys.exit(1)


# --- Typer æ‡‰ç”¨ç¨‹å¼å¯¦ä¾‹åŒ– ---

# ä¸»æ‡‰ç”¨ç¨‹å¼
app = typer.Typer(help="å­¸æ¸¬è‡´å‹ç³»çµ± CLI - æ‚¨çš„å€‹äººåŒ–å­¸ç¿’å¼•æ“")
# 'task' å­å‘½ä»¤ç¾¤çµ„
task_app = typer.Typer(help="ç®¡ç†æ‚¨çš„å­¸ç¿’ä»»å‹™")
# å°‡å­å‘½ä»¤ç¾¤çµ„åŠ å…¥ä¸»æ‡‰ç”¨ç¨‹å¼
app.add_typer(task_app, name="task")


# --- æ ¸å¿ƒé‚è¼¯å‡½å¼ ---

def get_subjects_dict() -> Dict[int, Dict]:
    """è®€å–å­¸ç§‘æª”æ¡ˆï¼Œä¸¦è½‰æ›ç‚ºä»¥ ID ç‚ºéµçš„å­—å…¸ä»¥ä¾¿å¿«é€ŸæŸ¥æ‰¾ã€‚"""
    subjects_data = load_data(SUBJECTS_FILE)
    # ç¢ºä¿ subjects.json çš„é ‚å±¤æ˜¯å­—å…¸ä¸”åŒ…å« 'subjects' éµ
    if isinstance(subjects_data, dict) and 'subjects' in subjects_data:
        return {s['id']: s for s in subjects_data['subjects']}
    return {}

def show_subjects():
    """é¡¯ç¤ºæ‰€æœ‰å­¸ç§‘çš„ç‹€æ…‹"""
    subjects_dict = get_subjects_dict()
    if not subjects_dict:
        typer.secho("æ‰¾ä¸åˆ°ä»»ä½•å­¸ç§‘è³‡æ–™ï¼Œè«‹æª¢æŸ¥ subjects.jsonã€‚", fg=typer.colors.RED)
        return

    print("--- æ‚¨çš„å­¸ç§‘ã€Œç´…é»ƒç¶ ã€ç‡ˆè™Ÿç›¤é»çµæœ ---\n")
    for subject in subjects_dict.values():
        name = subject.get('name', 'æœªçŸ¥å­¸ç§‘')
        status = subject.get('status', 'unknown').lower()
        description = subject.get('description', 'æ²’æœ‰æè¿°')

        color_map = {
            'green': Fore.GREEN,
            'yellow': Fore.YELLOW,
            'red': Fore.RED
        }
        symbol_map = {
            'green': 'âœ…',
            'yellow': 'ğŸŸ¡',
            'red': 'ğŸ”´'
        }
        
        color = color_map.get(status, Fore.WHITE)
        symbol = symbol_map.get(status, 'âšªï¸')
        
        print(color + f"{symbol} {name} ({status.capitalize()})")
        print(Style.DIM + f"   æè¿°ï¼š{description}\n")


# --- Typer å‘½ä»¤å®šç¾© ---

@app.command(name="show-subjects")
def show_subjects_command():
    """
    é¡¯ç¤ºæ‰€æœ‰å­¸ç§‘çš„ç›¤é»ç‹€æ…‹ã€‚
    """
    show_subjects()

@task_app.command(name="list")
def list_tasks(
    status: str = typer.Option("all", "--status", "-s", help="ä¾ç‹€æ…‹ç¯©é¸ä»»å‹™ (all, todo, doing, done)")
):
    """
    åˆ—å‡ºæ‰€æœ‰ä»»å‹™ã€‚
    """
    tasks = load_data(TASKS_FILE)
    subjects_dict = get_subjects_dict()

    if not tasks:
        typer.secho("ç›®å‰æ²’æœ‰ä»»ä½•ä»»å‹™ã€‚", fg=typer.colors.YELLOW)
        return

    typer.secho(f"--- ä»»å‹™åˆ—è¡¨ (ç‹€æ…‹: {status}) ---", bold=True)
    
    status_colors = {
        "todo": typer.colors.RED,
        "doing": typer.colors.YELLOW,
        "done": typer.colors.GREEN,
    }

    found_task = False
    for task in tasks:
        task_status = task.get('status', 'unknown')
        if status.lower() != 'all' and task_status != status.lower():
            continue
        
        found_task = True
        subject_id = task.get('subject_id')
        subject_name = subjects_dict.get(subject_id, {}).get('name', 'æœªçŸ¥ç§‘ç›®')
        
        color = status_colors.get(task_status, typer.colors.WHITE)
        
        typer.secho(f"ID: {task['task_id']:<3}", nl=False)
        typer.secho(f"[{task_status.upper():^5}] ", fg=color, nl=False)
        typer.secho(f"({subject_name}) ", fg=typer.colors.BLUE, nl=False)
        typer.secho(f"{task['description']}", nl=False)
        typer.secho(f"  æˆªæ­¢æ—¥æœŸï¼š{task.get('due_date', 'æœªè¨­å®š')}")
    if not found_task:
        typer.secho(f"æ‰¾ä¸åˆ°ç‹€æ…‹ç‚º '{status}' çš„ä»»å‹™ã€‚", fg=typer.colors.YELLOW)


@task_app.command(name="add")
def add_task(
    description: str = typer.Argument(..., help="ä»»å‹™çš„è©³ç´°æè¿°ã€‚"),
    subject_id: int = typer.Option(..., "--subject-id", "-id", prompt=True, help="æ­¤ä»»å‹™æ­¸å±¬çš„å­¸ç§‘IDã€‚"),
    resource_code: Optional[str] = typer.Option(None, "--resource", "-r", help="é—œè¯çš„è³‡æºä»£ç¢¼ã€‚"),
    due_date: Optional[str] = typer.Option(None, "--due", "-d", help="ä»»å‹™æˆªæ­¢æ—¥æœŸ (æ ¼å¼: YYYY-MM-DD)ã€‚")
):
    """
    æ–°å¢ä¸€ç­†æ–°çš„å­¸ç¿’ä»»å‹™ã€‚
    """
    tasks = load_data(TASKS_FILE)

    # è‡ªå‹•è¨ˆç®—æ–°ä»»å‹™çš„ ID
    if not tasks:
        new_id = 1
    else:
        # ä½¿ç”¨ç”Ÿæˆå™¨è¡¨é”å¼ï¼Œæ›´é«˜æ•ˆ
        max_id = max(task.get('task_id', 0) for task in tasks)
        new_id = max_id + 1

    # å»ºç«‹æ–°ä»»å‹™çš„å­—å…¸ç‰©ä»¶
    new_task = {
        "task_id": new_id,
        "subject_id": subject_id,
        "description": description,
        "resource_code": resource_code,
        "status": "todo", # æ–°ä»»å‹™é è¨­ç‚º 'todo'
        "type": "study",   # é è¨­ç‚º 'study'
        "due_date": due_date,
        "peak_time_required": False, # é è¨­ç‚º False
        "last_review_date": None,
        "next_review_date": None,
        "review_interval": 0
    }

    # å°‡æ–°ä»»å‹™åŠ å…¥åˆ—è¡¨ä¸¦å„²å­˜
    tasks.append(new_task)
    save_data(TASKS_FILE, tasks)

    typer.secho(f"âœ… æˆåŠŸæ–°å¢ä»»å‹™ (ID: {new_id}): {description}", fg=typer.colors.GREEN)


if __name__ == '__main__':
    app()
```

* resources.json
```json
[
  {
    "resource_code": "math_ref_book_1",
    "name": "æ•¸å­¸å¤§æ»¿è²«A 1-2",
    "type": "åƒè€ƒæ›¸",
    "subject_id": "math"
  },
  {
    "resource_code": "eng_vocab_7000",
    "name": "7000å–®å­—",
    "type": "å–®å­—æ›¸",
    "subject_id": "eng"
  },
  {
    "resource_code": "chem_ref_book",
    "name": "å¥½å¥½å­¸åŒ–å­¸å­¸æ¸¬ç¸½è¤‡ç¿’è¬›ç¾©",
    "type": "åƒè€ƒæ›¸",
    "subject_id": "chem"
  },
  {
    "resource_code": "bio_ref_book",
    "name": "é«˜ä¸­å­¸æ¸¬é€±è¨ˆç•«-ç”Ÿç‰©",
    "type": "åƒè€ƒæ›¸",
    "subject_id": "bio"
  },
  {
    "resource_code": "chi_ref_book",
    "name": "åœ‹æ–‡å¤§æ¨¡ç¥",
    "type": "åƒè€ƒæ›¸",
    "subject_id": "chi"
  },
  {
    "resource_code": "earth_ref_book",
    "name": "å¥½å¥½å­¸åœ°ç§‘å­¸æ¸¬ç¸½è¤‡ç¿’è¬›ç¾©",
    "type": "åƒè€ƒæ›¸",
    "subject_id": "earth"
  },
  {
    "resource_code": "phy_ref_book",
    "name": "ç‰©ç†æ–°å¤§æ»¿è²«",
    "type": "åƒè€ƒæ›¸",
    "subject_id": "phy"
  }

]
```

* subjects.json
```json
{
  "subjects": [
    {
      "id":"math",
      "name": "æ•¸å­¸",
      "status": "red",
      "description": "å¾®ç©åˆ†éƒ¨åˆ†çš„æ¦‚å¿µé‚„æœ‰äº›æ¨¡ç³Šï¼Œç‰¹åˆ¥æ˜¯æ‡‰ç”¨é¡Œçš„éƒ¨åˆ†ã€‚"
    },
    {
      "id":"phy",
      "name": "ç‰©ç†",
      "status": "red",
      "description": "é›»ç£å­¸å®Œå…¨ç„¡æ³•ç†è§£ï¼Œéœ€è¦å¾é ­é–‹å§‹å­¸ç¿’ã€‚"
    },
    {
      "id":"chem",
      "name": "åŒ–å­¸",
      "status": "red",
      "description": "å°æ–¼åŒ–å­¸éµç¯€çš„éƒ¨åˆ†ä¸ç†Ÿæ‚‰ã€‚"
    },
    {
      "id":"bio",
      "name": "ç”Ÿç‰©",
      "status": "red",
      "description": "æ¿€ç´ èª¿ç¯€çš„éƒ¨åˆ†é‚„æœ‰äº›æ¨¡ç³Šã€‚"
    },
    {
      "id":"earth",
      "name": "åœ°çƒç§‘å­¸",
      "status": "red",
      "description": "å¤§æ°£å±¤çš„éƒ¨åˆ†ä¸æ¸…æ¥šã€‚"
    },
    {
      "id":"eng",
      "name": "è‹±æ–‡",
      "status": "red",
      "description": "å–®å­—é‡ä¸å¤ ï¼Œéœ€è¦åŠ å¼·èƒŒèª¦ã€‚"
    },
    {
      "id":"chi",
      "name": "åœ‹æ–‡",
      "status": "red",
      "description": "æ–‡è¨€æ–‡é–±è®€è§£è®€å›°é›£ã€‚"
    },
    {
      "id":"health",
      "name": "å¥åº·",
      "status": "red",
      "description": "èº«é«”ç‹€æ…‹ä¸ä½³ã€‚"
    }
  ]
}

```

* tasks.json
```json
[
  {
    "task_id": 1,
    "subject_id": "math",
    "description": "å®Œæˆæ•¸å­¸è¬›ç¾©ç¬¬ä¸€ç« ï¼šæ•¸èˆ‡å¼",
    "resource_code": "math_ref_book_1",
    "status": "todo",
    "type": "study",
    "due_date": "2025-07-25",
    "peak_time_required": true,
    "last_review_date": null,
    "next_review_date": null,
    "review_interval": 0
  },
  {
    "task_id": 2,
    "subject_id": "eng",
    "description": "è¤‡ç¿’ 7000 å–®å­— List 1",
    "resource_code": "eng_vocab_7000_L1-10",
    "status": "todo",
    "type": "study",
    "due_date": null,
    "peak_time_required": false,
    "last_review_date": "2025-07-20",
    "next_review_date": "2025-07-22",
    "review_interval": 2
  },
  {
    "task_id": 3,
    "subject_id": "chem",
    "description": " å®ŒæˆåŒ–å­¸è¬›ç¾©ç¬¬ä¸€ç« ï¼šåŒ–å­¸åæ‡‰",
    "resource_code": "chem_ref_book",
    "status": "todo",
    "type": "study",
    "due_date": "2025-07-28",
    "peak_time_required": true,
    "last_review_date": null,
    "next_review_date": null,
    "review_interval": 0
  },
  {
    "task_id": 4,
    "subject_id": "hleath",
    "description": "æ™šä¸Šå»å…¬åœ’è·‘æ­¥ 30 åˆ†é˜",
    "resource_code": null,
    "status": "todo",
    "type": "wellbeing",
    "due_date": "2025-07-21",
    "peak_time_required": false,
    "last_review_date": null,
    "next_review_date": null,
    "review_interval": 0
  },
  {
    "task_id": 5,
    "subject_id": "phy",
    "description": "è¨‚æ­£é«˜ä¸€ç‰©ç†ç¬¬ä¸€æ¬¡æ®µè€ƒéŒ¯é¡Œ",
    "resource_code": "geo_notes_B1",
    "status": "done",
    "type": "study",
    "due_date": "2025-07-19",
    "peak_time_required": false,
    "last_review_date": "2025-07-19",
    "next_review_date": "2025-07-20",
    "review_interval": 1
  },
  {
    "task_id": 6,
    "subject_id": "bio",
    "description": "å®Œæˆç”Ÿç‰©ç¬¬ä¸€é€±è©¦é¡Œ",
    "resource_code": "bio_ref_book",
    "status": "todo",
    "type": "study",
    "due_date": null,
    "peak_time_required": false,
    "last_review_date": null,
    "next_review_date": null,
    "review_interval": 0
  },
  {
    "task_id": 7,
    "subject_id": "bio",
    "description": "å®Œæˆç”Ÿç‰©ç¬¬ä¸€é€±è©¦é¡Œ",
    "resource_code": null,
    "status": "todo",
    "type": "study",
    "due_date": "2025-08-01",
    "peak_time_required": false,
    "last_review_date": null,
    "next_review_date": null,
    "review_interval": 0
  }
]
```